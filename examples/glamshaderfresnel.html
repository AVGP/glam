<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="../libs/jquery-1.9.1/jquery-1.9.1.js"></script>
<script src="../libs/parsecss/jquery.parsecss.js" ></script>
<script src="../libs/vizi/vizi.js" ></script>
<script src="../src/glam.js" ></script>
<script src="../src/parser.js" ></script>
<script src="../src/cube.js" ></script>
<script src="../src/cone.js" ></script>
<script src="../src/cylinder.js" ></script>
<script src="../src/sphere.js" ></script>
<script src="../src/material.js" ></script>
<script src="../src/transform.js" ></script>
<script src="../src/animation.js" ></script>
<script src="../src/background.js" ></script>
<script src="../src/viewer.js" ></script>
<title>glam - fresnel shader</title>

<style>
	#sphere1 {
		color-diffuse:lightgray;
		envmap-right:url(../images/Park2/posx.jpg);
		envmap-left:url(../images/Park2/negx.jpg);
		envmap-top:url(../images/Park2/posy.jpg);
		envmap-bottom:url(../images/Park2/negy.jpg);
		envmap-front:url(../images/Park2/posz.jpg);
		envmap-back:url(../images/Park2/negz.jpg);
		shader-vertex:fresnelvs;
		shader-fragment:fresnelfs;
		shader-uniforms:mRefractionRatio f 1.02 mFresnelBias f 0.1 mFresnelPower f 2.0 mFresnelScale f 1.0 tCube t null;
	}
	
	#sb1 {
		background-type:box;
		envmap-right:url(../images/Park2/posx.jpg);
		envmap-left:url(../images/Park2/negx.jpg);
		envmap-top:url(../images/Park2/posy.jpg);
		envmap-bottom:url(../images/Park2/negy.jpg);
		envmap-front:url(../images/Park2/posz.jpg);
		envmap-back:url(../images/Park2/negz.jpg);
	}
	
</style>
<script>
$(document).ready(function(){

	glam.ready();
});

</script>
</head>
<body>
<!-- 
glam - Simple scene with cube
 -->
<div id="container" style="width:80%; height:80%;position:absolute;">
<script id="glam1" type="text/glam">
<glam>
  <scene>
	<background id="sb1"/>
	<sphere id="sphere1"/>
  </scene>
</glam>
</script>
</div>

<script id="fresnelvs" type="x-shader/x-vertex">
uniform float mRefractionRatio;
uniform float mFresnelBias;
uniform float mFresnelScale;
uniform float mFresnelPower;

varying vec3 vReflect;
varying vec3 vRefract[3];
varying float vReflectionFactor;

void main() {

	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
	vec4 worldPosition = modelMatrix * vec4( position, 1.0 );

	vec3 worldNormal = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );

	vec3 I = worldPosition.xyz - cameraPosition;

	vReflect = reflect( I, worldNormal );
	vRefract[0] = refract( normalize( I ), worldNormal, mRefractionRatio );
	vRefract[1] = refract( normalize( I ), worldNormal, mRefractionRatio * 0.99 );
	vRefract[2] = refract( normalize( I ), worldNormal, mRefractionRatio * 0.98 );
	vReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), worldNormal ), mFresnelPower );

	gl_Position = projectionMatrix * mvPosition;

}
</script>
<script id="fresnelfs" type="x-shader/x-fragment">
uniform samplerCube tCube;

varying vec3 vReflect;
varying vec3 vRefract[3];
varying float vReflectionFactor;

void main() {

	vec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );
	vec4 refractedColor = vec4( 1.0 );

	refractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;
	refractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;
	refractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;

	gl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );

}
</script>
</body>
</html>